<!doctype html>
<html lang="es-AR" class="h-full" x-data="AAPPApp()" x-init="init()">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AAPP Manager — Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          boxShadow: {
            soft: '0 10px 25px rgba(0,0,0,.25)',
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --blue-acc: 56 189 248; /* sky-400 */
      --blue-acc2: 59 130 246; /* blue-500 */
    }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .ring-blue-soft { box-shadow: 0 0 0 1px rgba(56,189,248,.20), 0 10px 25px rgba(0,0,0,.25); }
    .scrollbar::-webkit-scrollbar{ height:10px; width:10px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(56,189,248,.25); border-radius: 999px; }
    .scrollbar::-webkit-scrollbar-track{ background: rgba(255,255,255,.04); }
    .badge {
      border: 1px solid rgba(56,189,248,.35);
      background: rgba(56,189,248,.08);
      color: rgb(186 230 253);
    }
    .btn {
      border: 1px solid rgba(56,189,248,.30);
      background: rgba(56,189,248,.10);
    }
    .btn:hover { background: rgba(56,189,248,.16); }
    .btn-danger {
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
    }
    .btn-danger:hover { background: rgba(239,68,68,.16); }
    .input {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      outline: none;
    }
    .input:focus {
      border-color: rgba(56,189,248,.55);
      box-shadow: 0 0 0 3px rgba(56,189,248,.15);
    }
    .table th { position: sticky; top: 0; background: rgba(2,6,23,.95); }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 border-b border-white/10 bg-slate-950/80 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl flex items-center justify-center glass ring-blue-soft">
        <i class="fa-solid fa-layer-group text-sky-300"></i>
      </div>
      <div class="flex-1">
        <h1 class="text-lg md:text-xl font-extrabold tracking-tight">
          AAPP Manager <span class="text-sky-300">•</span> Dashboard
        </h1>
        <p class="text-xs md:text-sm text-slate-300">
          Todo local (localStorage) • CRUD • Relaciones • Resúmenes
        </p>
      </div>

      <div class="flex items-center gap-2">
        <button class="btn rounded-xl px-3 py-2 text-sm flex items-center gap-2" @click="toggleDark()">
          <i class="fa-solid" :class="isDark ? 'fa-moon text-sky-300' : 'fa-sun text-yellow-300'"></i>
          <span class="hidden sm:inline" x-text="isDark ? 'Dark' : 'Light'"></span>
        </button>

        <button class="btn rounded-xl px-3 py-2 text-sm flex items-center gap-2" @click="openModal('dataTools')">
          <i class="fa-solid fa-database text-sky-300"></i>
          <span class="hidden sm:inline">Datos</span>
        </button>

        <button class="btn-danger rounded-xl px-3 py-2 text-sm flex items-center gap-2" @click="resetAll()">
          <i class="fa-solid fa-triangle-exclamation text-red-300"></i>
          <span class="hidden sm:inline">Reset</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Quick KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="glass rounded-2xl p-4 ring-blue-soft">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-300">Empresas</div>
          <i class="fa-solid fa-building text-sky-300"></i>
        </div>
        <div class="mt-2 text-2xl font-extrabold" x-text="db.saas.length"></div>
        <div class="mt-2 text-xs text-slate-400">SaaS registradas</div>
      </div>

      <div class="glass rounded-2xl p-4 ring-blue-soft">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-300">Clientes</div>
          <i class="fa-solid fa-users text-sky-300"></i>
        </div>
        <div class="mt-2 text-2xl font-extrabold" x-text="db.clients.length"></div>
        <div class="mt-2 text-xs text-slate-400">Con planes + extras</div>
      </div>

      <div class="glass rounded-2xl p-4 ring-blue-soft">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-300">Ingresos (estim.)</div>
          <i class="fa-solid fa-arrow-trend-up text-emerald-300"></i>
        </div>
        <div class="mt-2 text-2xl font-extrabold">
          <span x-text="fmtMoney(totalIncomeEstimate())"></span>
        </div>
        <div class="mt-2 text-xs text-slate-400">Planes + extras (por frecuencia)</div>
      </div>

      <div class="glass rounded-2xl p-4 ring-blue-soft">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-300">Ads (total)</div>
          <i class="fa-solid fa-bullhorn text-sky-300"></i>
        </div>
        <div class="mt-2 text-2xl font-extrabold">
          <span x-text="fmtMoney(totalAdsSpendAllTime())"></span>
        </div>
        <div class="mt-2 text-xs text-slate-400">Gasto total con impuestos</div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="glass rounded-2xl p-3 ring-blue-soft">
      <div class="flex flex-wrap gap-2">
        <template x-for="t in tabs" :key="t.key">
          <button
            class="px-3 py-2 rounded-xl text-sm font-semibold flex items-center gap-2 border border-white/10"
            :class="activeTab === t.key ? 'bg-sky-500/15 border-sky-400/30 text-sky-200' : 'bg-white/5 hover:bg-white/8 text-slate-200'"
            @click="activeTab = t.key">
            <i class="fa-solid" :class="t.icon"></i>
            <span x-text="t.label"></span>
          </button>
        </template>

        <div class="ml-auto flex items-center gap-2">
          <input class="input rounded-xl px-3 py-2 text-sm w-64 max-w-full"
                 placeholder="Buscar por nombre / URL / notas…"
                 x-model="q" />
          <span class="badge text-xs px-2 py-1 rounded-lg" x-text="'Registros: ' + totalRecordsFiltered()"></span>
        </div>
      </div>
    </section>

    <!-- Content -->
    <section class="mt-4">
      <!-- SaaS -->
      <div x-show="activeTab==='saas'" x-transition.opacity>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-extrabold">Empresas SaaS</h2>
          <span class="badge text-xs px-2 py-1 rounded-lg">Nombre • URL • Registro • Login • Relación</span>
          <div class="ml-auto">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="openModal('saasForm')">
              <i class="fa-solid fa-plus mr-2 text-sky-300"></i>Agregar
            </button>
          </div>
        </div>

        <div class="glass rounded-2xl overflow-hidden">
          <div class="overflow-auto scrollbar">
            <table class="min-w-full table">
              <thead>
                <tr class="text-left text-xs text-slate-300 border-b border-white/10">
                  <th class="p-3">Nombre</th>
                  <th class="p-3">URL</th>
                  <th class="p-3">Registro</th>
                  <th class="p-3">Login</th>
                  <th class="p-3">Clientes</th>
                  <th class="p-3">Planes</th>
                  <th class="p-3 w-40">Acciones</th>
                </tr>
              </thead>
              <tbody class="text-sm">
                <template x-for="s in filteredSaaS()" :key="s.id">
                  <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-3 font-semibold" x-text="s.name"></td>
                    <td class="p-3">
                      <a class="text-sky-300 hover:underline" :href="s.url" target="_blank" x-text="shortUrl(s.url)"></a>
                    </td>
                    <td class="p-3">
                      <a class="text-sky-300 hover:underline" :href="s.registerUrl" target="_blank" x-text="s.registerUrl ? 'Abrir' : '-'"></a>
                    </td>
                    <td class="p-3">
                      <a class="text-sky-300 hover:underline" :href="s.loginUrl" target="_blank" x-text="s.loginUrl ? 'Abrir' : '-'"></a>
                    </td>
                    <td class="p-3">
                      <span class="badge px-2 py-1 rounded-lg text-xs" x-text="countClientsBySaas(s.id)"></span>
                    </td>
                    <td class="p-3">
                      <span class="badge px-2 py-1 rounded-lg text-xs" x-text="countPlansBySaas(s.id)"></span>
                    </td>
                    <td class="p-3">
                      <div class="flex gap-2">
                        <button class="btn rounded-xl px-3 py-2 text-xs" @click="editSaas(s.id)">
                          <i class="fa-solid fa-pen-to-square text-sky-300 mr-1"></i>Editar
                        </button>
                        <button class="btn-danger rounded-xl px-3 py-2 text-xs" @click="delSaas(s.id)">
                          <i class="fa-solid fa-trash text-red-300 mr-1"></i>Borrar
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr x-show="filteredSaaS().length===0">
                  <td class="p-6 text-slate-400" colspan="7">
                    No hay registros. Agregá tus SaaS (ej: aapp.space, minitienda.uno).
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Plans -->
      <div x-show="activeTab==='plans'" x-transition.opacity>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-extrabold">Planes</h2>
          <span class="badge text-xs px-2 py-1 rounded-lg">Mensual • Anual • Empresa</span>
          <div class="ml-auto">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="openModal('planForm')">
              <i class="fa-solid fa-plus mr-2 text-sky-300"></i>Agregar
            </button>
          </div>
        </div>

        <div class="glass rounded-2xl overflow-hidden">
          <div class="overflow-auto scrollbar">
            <table class="min-w-full table">
              <thead>
                <tr class="text-left text-xs text-slate-300 border-b border-white/10">
                  <th class="p-3">Título</th>
                  <th class="p-3">Frecuencia</th>
                  <th class="p-3">Precio</th>
                  <th class="p-3">Empresa</th>
                  <th class="p-3">Descripción</th>
                  <th class="p-3 w-40">Acciones</th>
                </tr>
              </thead>
              <tbody class="text-sm">
                <template x-for="p in filteredPlans()" :key="p.id">
                  <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-3 font-semibold" x-text="p.title"></td>
                    <td class="p-3">
                      <span class="badge px-2 py-1 rounded-lg text-xs" x-text="p.frequency"></span>
                    </td>
                    <td class="p-3 font-bold" x-text="fmtMoney(p.price)"></td>
                    <td class="p-3">
                      <span class="text-sky-200 font-semibold" x-text="saasName(p.saasId)"></span>
                    </td>
                    <td class="p-3 text-slate-300" x-text="p.description || '-'"></td>
                    <td class="p-3">
                      <div class="flex gap-2">
                        <button class="btn rounded-xl px-3 py-2 text-xs" @click="editPlan(p.id)">
                          <i class="fa-solid fa-pen-to-square text-sky-300 mr-1"></i>Editar
                        </button>
                        <button class="btn-danger rounded-xl px-3 py-2 text-xs" @click="delPlan(p.id)">
                          <i class="fa-solid fa-trash text-red-300 mr-1"></i>Borrar
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr x-show="filteredPlans().length===0">
                  <td class="p-6 text-slate-400" colspan="6">
                    No hay planes todavía. Creá planes mensuales/anuales por empresa.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Campaigns -->
      <div x-show="activeTab==='campaigns'" x-transition.opacity>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-extrabold">Campañas Publicitarias</h2>
          <span class="badge text-xs px-2 py-1 rounded-lg">Impuestos auto • Resúmenes</span>
          <div class="ml-auto flex items-center gap-2">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="openModal('campaignForm')">
              <i class="fa-solid fa-plus mr-2 text-sky-300"></i>Agregar
            </button>
          </div>
        </div>

        <!-- Summary cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="glass rounded-2xl p-4 ring-blue-soft">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-300">Hoy (estim.)</div>
              <i class="fa-solid fa-calendar-day text-sky-300"></i>
            </div>
            <div class="mt-2 text-2xl font-extrabold" x-text="fmtMoney(adsSpendToday())"></div>
            <div class="mt-2 text-xs text-slate-400">Suma de (gasto_día + impuestos) por campaña</div>
          </div>

          <div class="glass rounded-2xl p-4 ring-blue-soft">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-300">Semana (7 días)</div>
              <i class="fa-solid fa-calendar-week text-sky-300"></i>
            </div>
            <div class="mt-2 text-2xl font-extrabold" x-text="fmtMoney(adsSpendWeek())"></div>
            <div class="mt-2 text-xs text-slate-400">Hoy * 7 (estimación rápida)</div>
          </div>

          <div class="glass rounded-2xl p-4 ring-blue-soft">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-300">Total (configurado)</div>
              <i class="fa-solid fa-sack-dollar text-sky-300"></i>
            </div>
            <div class="mt-2 text-2xl font-extrabold" x-text="fmtMoney(totalAdsSpendAllTime())"></div>
            <div class="mt-2 text-xs text-slate-400">Suma de gasto_total (con impuestos)</div>
          </div>
        </div>

        <div class="glass rounded-2xl overflow-hidden">
          <div class="overflow-auto scrollbar">
            <table class="min-w-full table">
              <thead>
                <tr class="text-left text-xs text-slate-300 border-b border-white/10">
                  <th class="p-3">Anuncio / Nombre</th>
                  <th class="p-3">Empresa</th>
                  <th class="p-3">Fecha</th>
                  <th class="p-3">Gasto por día</th>
                  <th class="p-3">Impuestos</th>
                  <th class="p-3">Gasto total</th>
                  <th class="p-3 w-40">Acciones</th>
                </tr>
              </thead>
              <tbody class="text-sm">
                <template x-for="c in filteredCampaigns()" :key="c.id">
                  <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-3 font-semibold" x-text="c.adName"></td>
                    <td class="p-3 text-sky-200 font-semibold" x-text="saasName(c.saasId)"></td>
                    <td class="p-3 text-slate-300" x-text="c.date"></td>
                    <td class="p-3 font-bold" x-text="fmtMoney(c.dailySpend)"></td>
                    <td class="p-3" x-text="fmtMoney(calcTaxes(c))"></td>
                    <td class="p-3 font-extrabold" x-text="fmtMoney(calcTotalWithTaxes(c))"></td>
                    <td class="p-3">
                      <div class="flex gap-2">
                        <button class="btn rounded-xl px-3 py-2 text-xs" @click="editCampaign(c.id)">
                          <i class="fa-solid fa-pen-to-square text-sky-300 mr-1"></i>Editar
                        </button>
                        <button class="btn-danger rounded-xl px-3 py-2 text-xs" @click="delCampaign(c.id)">
                          <i class="fa-solid fa-trash text-red-300 mr-1"></i>Borrar
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr x-show="filteredCampaigns().length===0">
                  <td class="p-6 text-slate-400" colspan="7">
                    Sin campañas. Registrá anuncios con gasto por día y total.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="mt-4 glass rounded-2xl p-4">
          <h3 class="font-extrabold mb-2">Reporte rápido (por empresa)</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <template x-for="s in db.saas" :key="'rep-'+s.id">
              <div class="border border-white/10 rounded-2xl p-4 bg-white/5">
                <div class="flex items-center justify-between">
                  <div class="font-extrabold text-sky-200" x-text="s.name"></div>
                  <span class="badge text-xs px-2 py-1 rounded-lg" x-text="'Campañas: ' + campaignsBySaas(s.id).length"></span>
                </div>
                <div class="mt-2 text-sm text-slate-300">
                  <div class="flex justify-between">
                    <span>Gasto total</span>
                    <span class="font-bold" x-text="fmtMoney(totalAdsSpendBySaas(s.id))"></span>
                  </div>
                  <div class="flex justify-between">
                    <span>Gasto diario (sum)</span>
                    <span class="font-bold" x-text="fmtMoney(sumDailySpendBySaas(s.id))"></span>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Clients -->
      <div x-show="activeTab==='clients'" x-transition.opacity>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-extrabold">Clientes</h2>
          <span class="badge text-xs px-2 py-1 rounded-lg">Plan activo • Extras • Total • Credenciales</span>
          <div class="ml-auto">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="openModal('clientForm')">
              <i class="fa-solid fa-plus mr-2 text-sky-300"></i>Agregar
            </button>
          </div>
        </div>

        <div class="glass rounded-2xl overflow-hidden">
          <div class="overflow-auto scrollbar">
            <table class="min-w-full table">
              <thead>
                <tr class="text-left text-xs text-slate-300 border-b border-white/10">
                  <th class="p-3">Nombre</th>
                  <th class="p-3">Empresa</th>
                  <th class="p-3">Plan activo</th>
                  <th class="p-3">Extras</th>
                  <th class="p-3">Total</th>
                  <th class="p-3">Fecha</th>
                  <th class="p-3">Notas</th>
                  <th class="p-3 w-40">Acciones</th>
                </tr>
              </thead>
              <tbody class="text-sm">
                <template x-for="cl in filteredClients()" :key="cl.id">
                  <tr class="border-b border-white/5 hover:bg-white/5 align-top">
                    <td class="p-3 font-semibold">
                      <div x-text="cl.name"></div>
                      <div class="text-xs text-slate-400 mt-1">
                        <div><i class="fa-regular fa-envelope mr-1"></i><span x-text="cl.email || '-'"></span></div>
                        <div><i class="fa-solid fa-key mr-1"></i><span x-text="cl.password || '-'"></span></div>
                      </div>
                      <div class="text-xs mt-2" x-show="(cl.links||'').trim().length">
                        <i class="fa-solid fa-link text-sky-300 mr-1"></i>
                        <span class="text-slate-300" x-text="cl.links"></span>
                      </div>
                    </td>

                    <td class="p-3 text-sky-200 font-semibold" x-text="saasName(cl.saasId)"></td>

                    <td class="p-3">
                      <div class="font-bold" x-text="planTitle(cl.planId)"></div>
                      <div class="text-xs text-slate-400" x-text="planFrequency(cl.planId)"></div>
                      <div class="text-xs text-slate-400" x-text="fmtMoney(planPrice(cl.planId))"></div>
                    </td>

                    <td class="p-3">
                      <template x-if="(cl.extraIds||[]).length">
                        <div class="flex flex-wrap gap-2">
                          <template x-for="eid in cl.extraIds" :key="eid">
                            <span class="badge px-2 py-1 rounded-lg text-xs" x-text="extraName(eid)"></span>
                          </template>
                        </div>
                      </template>
                      <div x-show="!(cl.extraIds||[]).length" class="text-slate-400">-</div>
                    </td>

                    <td class="p-3 font-extrabold" x-text="fmtMoney(clientTotal(cl))"></td>

                    <td class="p-3 text-slate-300" x-text="cl.date || '-'"></td>
                    <td class="p-3 text-slate-300" x-text="cl.notes || '-'"></td>

                    <td class="p-3">
                      <div class="flex gap-2">
                        <button class="btn rounded-xl px-3 py-2 text-xs" @click="editClient(cl.id)">
                          <i class="fa-solid fa-pen-to-square text-sky-300 mr-1"></i>Editar
                        </button>
                        <button class="btn-danger rounded-xl px-3 py-2 text-xs" @click="delClient(cl.id)">
                          <i class="fa-solid fa-trash text-red-300 mr-1"></i>Borrar
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr x-show="filteredClients().length===0">
                  <td class="p-6 text-slate-400" colspan="8">
                    Sin clientes. Agregá clientes con plan activo y extras.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Extras -->
      <div x-show="activeTab==='extras'" x-transition.opacity>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-extrabold">Servicios Extras</h2>
          <span class="badge text-xs px-2 py-1 rounded-lg">Mensual • Anual • Única vez</span>
          <div class="ml-auto">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="openModal('extraForm')">
              <i class="fa-solid fa-plus mr-2 text-sky-300"></i>Agregar
            </button>
          </div>
        </div>

        <div class="glass rounded-2xl overflow-hidden">
          <div class="overflow-auto scrollbar">
            <table class="min-w-full table">
              <thead>
                <tr class="text-left text-xs text-slate-300 border-b border-white/10">
                  <th class="p-3">Nombre</th>
                  <th class="p-3">Frecuencia</th>
                  <th class="p-3">Precio</th>
                  <th class="p-3 w-40">Acciones</th>
                </tr>
              </thead>
              <tbody class="text-sm">
                <template x-for="e in filteredExtras()" :key="e.id">
                  <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-3 font-semibold" x-text="e.name"></td>
                    <td class="p-3"><span class="badge text-xs px-2 py-1 rounded-lg" x-text="e.frequency"></span></td>
                    <td class="p-3 font-bold" x-text="fmtMoney(e.price)"></td>
                    <td class="p-3">
                      <div class="flex gap-2">
                        <button class="btn rounded-xl px-3 py-2 text-xs" @click="editExtra(e.id)">
                          <i class="fa-solid fa-pen-to-square text-sky-300 mr-1"></i>Editar
                        </button>
                        <button class="btn-danger rounded-xl px-3 py-2 text-xs" @click="delExtra(e.id)">
                          <i class="fa-solid fa-trash text-red-300 mr-1"></i>Borrar
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr x-show="filteredExtras().length===0">
                  <td class="p-6 text-slate-400" colspan="4">
                    Sin extras todavía. Ej: Dominio .com, Logo, Setup, Ads, etc.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Balance -->
      <div x-show="activeTab==='balance'" x-transition.opacity>
        <div class="flex items-center gap-2 mb-3">
          <h2 class="text-lg font-extrabold">Balance</h2>
          <span class="badge text-xs px-2 py-1 rounded-lg">Ingresos • Egresos • Ventas • Dominios • Extras</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4 ring-blue-soft">
            <h3 class="font-extrabold mb-3">Resumen (estimado desde Clientes)</h3>

            <div class="space-y-2 text-sm text-slate-200">
              <div class="flex justify-between">
                <span>Ventas (cantidad clientes)</span>
                <span class="font-bold" x-text="db.clients.length"></span>
              </div>
              <div class="flex justify-between">
                <span>Ingresos (planes + extras normalizado/mes)</span>
                <span class="font-extrabold" x-text="fmtMoney(totalIncomeEstimate())"></span>
              </div>
              <div class="flex justify-between">
                <span>Ads (gasto diario total)</span>
                <span class="font-bold" x-text="fmtMoney(sumDailySpendAll())"></span>
              </div>
              <div class="flex justify-between">
                <span>Ads (gasto total con impuestos)</span>
                <span class="font-extrabold" x-text="fmtMoney(totalAdsSpendAllTime())"></span>
              </div>
            </div>

            <div class="mt-4 border-t border-white/10 pt-4">
              <h4 class="font-bold mb-2">Desglose (por tipo)</h4>
              <div class="space-y-2 text-sm text-slate-200">
                <div class="flex justify-between">
                  <span>Planes (estimado/mes)</span>
                  <span class="font-bold" x-text="fmtMoney(incomePlansMonthlyEstimate())"></span>
                </div>
                <div class="flex justify-between">
                  <span>Servicios extras (estimado/mes)</span>
                  <span class="font-bold" x-text="fmtMoney(incomeExtrasMonthlyEstimate())"></span>
                </div>
                <div class="flex justify-between">
                  <span>Dominios contratados (conteo)</span>
                  <span class="font-bold" x-text="domainExtrasCount()"></span>
                </div>
              </div>
            </div>

          </div>

          <div class="glass rounded-2xl p-4 ring-blue-soft">
            <h3 class="font-extrabold mb-3">Egresos manuales (opcional)</h3>
            <p class="text-sm text-slate-300 mb-4">
              Si querés llevar egresos que no salen de campañas (sueldos, hosting, etc.), registralos acá.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <input class="input rounded-xl px-3 py-2 text-sm" placeholder="Concepto" x-model="expenseForm.name" />
              <input class="input rounded-xl px-3 py-2 text-sm" placeholder="Monto (ARS)" type="number" x-model.number="expenseForm.amount" />
              <input class="input rounded-xl px-3 py-2 text-sm" placeholder="Fecha (YYYY-MM-DD)" x-model="expenseForm.date" />
            </div>

            <div class="mt-3 flex gap-2">
              <button class="btn rounded-xl px-3 py-2 text-sm" @click="addExpense()">
                <i class="fa-solid fa-plus text-sky-300 mr-2"></i>Agregar egreso
              </button>
              <button class="btn-danger rounded-xl px-3 py-2 text-sm" @click="clearExpenses()">
                <i class="fa-solid fa-trash text-red-300 mr-2"></i>Limpiar
              </button>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between mb-2">
                <div class="font-bold">Lista de egresos</div>
                <div class="badge text-xs px-2 py-1 rounded-lg" x-text="'Total: ' + fmtMoney(totalExpensesManual())"></div>
              </div>

              <div class="max-h-64 overflow-auto scrollbar rounded-2xl border border-white/10">
                <template x-for="(ex, idx) in db.expenses" :key="'ex-'+idx">
                  <div class="flex items-center justify-between px-3 py-2 border-b border-white/5 bg-white/5">
                    <div class="text-sm">
                      <div class="font-semibold" x-text="ex.name"></div>
                      <div class="text-xs text-slate-400" x-text="ex.date || '-'"></div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="font-extrabold" x-text="fmtMoney(ex.amount)"></div>
                      <button class="btn-danger rounded-xl px-3 py-2 text-xs" @click="removeExpense(idx)">
                        <i class="fa-solid fa-xmark"></i>
                      </button>
                    </div>
                  </div>
                </template>
                <div class="p-4 text-slate-400 text-sm" x-show="db.expenses.length===0">
                  No hay egresos cargados.
                </div>
              </div>

              <div class="mt-4 border-t border-white/10 pt-4 text-sm">
                <div class="flex justify-between">
                  <span>Ingresos (estim.)</span>
                  <span class="font-bold" x-text="fmtMoney(totalIncomeEstimate())"></span>
                </div>
                <div class="flex justify-between">
                  <span>Egresos manuales</span>
                  <span class="font-bold" x-text="fmtMoney(totalExpensesManual())"></span>
                </div>
                <div class="flex justify-between">
                  <span>Ads total</span>
                  <span class="font-bold" x-text="fmtMoney(totalAdsSpendAllTime())"></span>
                </div>
                <div class="flex justify-between mt-2">
                  <span class="font-extrabold text-sky-200">Saldo (estim.)</span>
                  <span class="font-extrabold text-sky-200" x-text="fmtMoney(balanceEstimate())"></span>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Settings/Help -->
      <div x-show="activeTab==='help'" x-transition.opacity>
        <div class="glass rounded-2xl p-5 ring-blue-soft">
          <h2 class="text-lg font-extrabold mb-2">Ayuda rápida</h2>
          <ul class="list-disc pl-6 text-sm text-slate-300 space-y-2">
            <li>Todo se guarda en tu navegador (localStorage). Si borrás datos del navegador, se pierde.</li>
            <li>Relaciones:
              <span class="text-sky-200 font-semibold">Planes</span> pertenecen a una <span class="text-sky-200 font-semibold">Empresa</span>;
              <span class="text-sky-200 font-semibold">Clientes</span> eligen un <span class="text-sky-200 font-semibold">Plan</span> y <span class="text-sky-200 font-semibold">Extras</span>.
            </li>
            <li>Campañas:
              <span class="text-sky-200 font-semibold">Gasto total = gasto por día + impuestos</span>.
              Acá calculamos: <span class="text-sky-200 font-semibold">Impuestos = (gasto total - gasto por día)</span>.
            </li>
            <li>En “Datos” podés exportar/importar JSON para backup o migración.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal overlay -->
  <div x-show="modal.open" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" @click="closeModal()"></div>

    <div class="relative w-full max-w-2xl glass rounded-2xl shadow-soft border border-white/10">
      <div class="flex items-center justify-between p-4 border-b border-white/10">
        <div class="font-extrabold text-sky-200" x-text="modal.title"></div>
        <button class="btn-danger rounded-xl px-3 py-2 text-sm" @click="closeModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="p-4 max-h-[75vh] overflow-auto scrollbar">
        <!-- SaaS Form -->
        <div x-show="modal.view==='saasForm'">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-300">Nombre</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.saas.name" placeholder="aapp.space / minitienda.uno" />
            </div>
            <div>
              <label class="text-xs text-slate-300">URL</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.saas.url" placeholder="https://aapp.space" />
            </div>
            <div>
              <label class="text-xs text-slate-300">Link de registro</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.saas.registerUrl" placeholder="https://..." />
            </div>
            <div>
              <label class="text-xs text-slate-300">Link de login</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.saas.loginUrl" placeholder="https://..." />
            </div>
          </div>

          <div class="mt-4 flex gap-2">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="saveSaas()">
              <i class="fa-solid fa-floppy-disk text-sky-300 mr-2"></i>Guardar
            </button>
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="closeModal()">Cancelar</button>
          </div>
        </div>

        <!-- Plan Form -->
        <div x-show="modal.view==='planForm'">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-300">Empresa</label>
              <select class="input rounded-xl px-3 py-2 w-full" x-model="forms.plan.saasId">
                <option value="">Seleccionar</option>
                <template x-for="s in db.saas" :key="'ps-'+s.id">
                  <option :value="s.id" x-text="s.name"></option>
                </template>
              </select>
            </div>

            <div>
              <label class="text-xs text-slate-300">Frecuencia</label>
              <select class="input rounded-xl px-3 py-2 w-full" x-model="forms.plan.frequency">
                <option>Por mes</option>
                <option>Por año</option>
              </select>
            </div>

            <div>
              <label class="text-xs text-slate-300">Título</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.plan.title" placeholder="Básico / Premium" />
            </div>

            <div>
              <label class="text-xs text-slate-300">Precio (ARS)</label>
              <input class="input rounded-xl px-3 py-2 w-full" type="number" x-model.number="forms.plan.price" placeholder="100000" />
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-300">Descripción</label>
              <textarea class="input rounded-xl px-3 py-2 w-full min-h-[90px]" x-model="forms.plan.description" placeholder="Qué incluye, límites, etc."></textarea>
            </div>
          </div>

          <div class="mt-4 flex gap-2">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="savePlan()">
              <i class="fa-solid fa-floppy-disk text-sky-300 mr-2"></i>Guardar
            </button>
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="closeModal()">Cancelar</button>
          </div>
        </div>

        <!-- Campaign Form -->
        <div x-show="modal.view==='campaignForm'">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-300">Empresa</label>
              <select class="input rounded-xl px-3 py-2 w-full" x-model="forms.campaign.saasId">
                <option value="">Seleccionar</option>
                <template x-for="s in db.saas" :key="'cs-'+s.id">
                  <option :value="s.id" x-text="s.name"></option>
                </template>
              </select>
            </div>

            <div>
              <label class="text-xs text-slate-300">Fecha</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.campaign.date" placeholder="YYYY-MM-DD" />
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-300">Anuncio / Nombre</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.campaign.adName" placeholder="Lead Ads / Campaña Navidad / etc" />
            </div>

            <div>
              <label class="text-xs text-slate-300">Gasto por día (ARS)</label>
              <input class="input rounded-xl px-3 py-2 w-full" type="number" x-model.number="forms.campaign.dailySpend" />
            </div>

            <div>
              <label class="text-xs text-slate-300">Gasto total (ARS)</label>
              <input class="input rounded-xl px-3 py-2 w-full" type="number" x-model.number="forms.campaign.totalSpend" />
              <div class="text-xs text-slate-400 mt-1">
                Impuestos = (total - diario) ⇒ <span class="text-sky-200 font-bold" x-text="fmtMoney(calcTaxes(forms.campaign))"></span>
              </div>
            </div>
          </div>

          <div class="mt-4 flex gap-2">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="saveCampaign()">
              <i class="fa-solid fa-floppy-disk text-sky-300 mr-2"></i>Guardar
            </button>
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="closeModal()">Cancelar</button>
          </div>
        </div>

        <!-- Extra Form -->
        <div x-show="modal.view==='extraForm'">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-300">Nombre</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.extra.name" placeholder="Logo, Dominio, Setup, Ads, etc" />
            </div>

            <div>
              <label class="text-xs text-slate-300">Frecuencia</label>
              <select class="input rounded-xl px-3 py-2 w-full" x-model="forms.extra.frequency">
                <option>Por mes</option>
                <option>Por año</option>
                <option>Única vez</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-300">Precio (ARS)</label>
              <input class="input rounded-xl px-3 py-2 w-full" type="number" x-model.number="forms.extra.price" />
            </div>
          </div>

          <div class="mt-4 flex gap-2">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="saveExtra()">
              <i class="fa-solid fa-floppy-disk text-sky-300 mr-2"></i>Guardar
            </button>
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="closeModal()">Cancelar</button>
          </div>
        </div>

        <!-- Client Form -->
        <div x-show="modal.view==='clientForm'">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-300">Nombre</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.client.name" placeholder="Nombre del cliente" />
            </div>

            <div>
              <label class="text-xs text-slate-300">Fecha</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.client.date" placeholder="YYYY-MM-DD" />
            </div>

            <div>
              <label class="text-xs text-slate-300">Empresa</label>
              <select class="input rounded-xl px-3 py-2 w-full" x-model="forms.client.saasId" @change="syncPlanToCompany()">
                <option value="">Seleccionar</option>
                <template x-for="s in db.saas" :key="'cl-s-'+s.id">
                  <option :value="s.id" x-text="s.name"></option>
                </template>
              </select>
            </div>

            <div>
              <label class="text-xs text-slate-300">Plan activo</label>
              <select class="input rounded-xl px-3 py-2 w-full" x-model="forms.client.planId">
                <option value="">Seleccionar</option>
                <template x-for="p in plansBySaas(forms.client.saasId)" :key="'cl-p-'+p.id">
                  <option :value="p.id" x-text="p.title + ' • ' + p.frequency + ' • ' + fmtMoney(p.price)"></option>
                </template>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-300">Servicios extras</label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-1">
                <template x-for="e in db.extras" :key="'ce-'+e.id">
                  <label class="flex items-center gap-2 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm">
                    <input type="checkbox" class="accent-sky-400"
                           :value="e.id"
                           @change="toggleClientExtra(e.id, $event.target.checked)"
                           :checked="(forms.client.extraIds||[]).includes(e.id)"/>
                    <span class="flex-1">
                      <span class="font-semibold" x-text="e.name"></span>
                      <span class="text-xs text-slate-400 ml-2" x-text="e.frequency + ' • ' + fmtMoney(e.price)"></span>
                    </span>
                  </label>
                </template>
                <div class="text-slate-400 text-sm" x-show="db.extras.length===0">
                  No hay extras creados todavía.
                </div>
              </div>
            </div>

            <div>
              <label class="text-xs text-slate-300">Correo</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.client.email" placeholder="correo@..." />
            </div>

            <div>
              <label class="text-xs text-slate-300">Contraseña</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.client.password" placeholder="(guardado local)" />
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-300">Enlaces</label>
              <input class="input rounded-xl px-3 py-2 w-full" x-model="forms.client.links" placeholder="Links relevantes (panel, drive, etc)" />
            </div>

            <div class="md:col-span-2">
              <label class="text-xs text-slate-300">Notas</label>
              <textarea class="input rounded-xl px-3 py-2 w-full min-h-[90px]" x-model="forms.client.notes" placeholder="Notas de seguimiento, estado, etc"></textarea>
            </div>
          </div>

          <div class="mt-3 text-sm text-slate-300">
            Total cliente (estimado): <span class="text-sky-200 font-extrabold" x-text="fmtMoney(clientTotal(forms.client))"></span>
          </div>

          <div class="mt-4 flex gap-2">
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="saveClient()">
              <i class="fa-solid fa-floppy-disk text-sky-300 mr-2"></i>Guardar
            </button>
            <button class="btn rounded-xl px-3 py-2 text-sm" @click="closeModal()">Cancelar</button>
          </div>
        </div>

        <!-- Data Tools -->
        <div x-show="modal.view==='dataTools'">
          <div class="space-y-3">
            <div class="glass rounded-2xl p-4 border border-white/10">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-extrabold">Exportar (backup)</div>
                  <div class="text-sm text-slate-300">Descargá un JSON con todo tu sistema.</div>
                </div>
                <button class="btn rounded-xl px-3 py-2 text-sm" @click="exportJSON()">
                  <i class="fa-solid fa-file-export text-sky-300 mr-2"></i>Exportar
                </button>
              </div>
            </div>

            <div class="glass rounded-2xl p-4 border border-white/10">
              <div class="font-extrabold">Importar (restaurar)</div>
              <div class="text-sm text-slate-300 mb-2">Pegá tu JSON y cargalo.</div>
              <textarea class="input rounded-2xl px-3 py-2 w-full min-h-[160px]" x-model="importText" placeholder='{"saas":[...],"plans":[...],...}'></textarea>
              <div class="mt-3 flex gap-2">
                <button class="btn rounded-xl px-3 py-2 text-sm" @click="importJSON()">
                  <i class="fa-solid fa-file-import text-sky-300 mr-2"></i>Importar
                </button>
                <button class="btn rounded-xl px-3 py-2 text-sm" @click="seedDemo()">
                  <i class="fa-solid fa-wand-magic-sparkles text-sky-300 mr-2"></i>Cargar demo
                </button>
              </div>
            </div>

            <div class="text-xs text-slate-400">
              Nota: Importar reemplaza todo el contenido actual.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    function AAPPApp() {
      const STORAGE_KEY = 'aapp_manager_v1';

      const uid = () => 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);

      const todayISO = () => {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      };

      return {
        isDark: true,
        activeTab: 'saas',
        q: '',
        importText: '',

        tabs: [
          { key: 'saas', label: 'Empresas', icon: 'fa-building' },
          { key: 'plans', label: 'Planes', icon: 'fa-tags' },
          { key: 'campaigns', label: 'Campañas', icon: 'fa-bullhorn' },
          { key: 'clients', label: 'Clientes', icon: 'fa-users' },
          { key: 'extras', label: 'Extras', icon: 'fa-puzzle-piece' },
          { key: 'balance', label: 'Balance', icon: 'fa-chart-line' },
          { key: 'help', label: 'Ayuda', icon: 'fa-circle-question' },
        ],

        db: {
          saas: [],
          plans: [],
          campaigns: [],
          extras: [],
          clients: [],
          expenses: [], // egresos manuales
          meta: { version: 1, savedAt: null }
        },

        expenseForm: { name: '', amount: 0, date: '' },

        modal: { open: false, view: '', title: '' },

        forms: {
          saas: { id: '', name: '', url: '', registerUrl: '', loginUrl: '' },
          plan: { id: '', saasId: '', frequency: 'Por mes', title: '', description: '', price: 0 },
          campaign: { id: '', saasId: '', adName: '', date: '', dailySpend: 0, totalSpend: 0 },
          extra: { id: '', name: '', price: 0, frequency: 'Única vez' },
          client: { id: '', name: '', saasId: '', planId: '', extraIds: [], email: '', password: '', date: '', notes: '', links: '' },
        },

        init() {
          // Dark mode default
          this.applyDarkClass();

          // Load DB
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            try {
              const parsed = JSON.parse(raw);
              this.db = this.normalizeDB(parsed);
            } catch (e) {
              console.warn('DB inválida, usando vacía', e);
              this.persist();
            }
          } else {
            // Seed mínimo con tus dos SaaS
            this.seedMinimal();
          }
        },

        normalizeDB(input) {
          const safe = (arr) => Array.isArray(arr) ? arr : [];
          const out = {
            saas: safe(input.saas),
            plans: safe(input.plans),
            campaigns: safe(input.campaigns),
            extras: safe(input.extras),
            clients: safe(input.clients),
            expenses: safe(input.expenses),
            meta: input.meta || { version: 1, savedAt: null }
          };
          return out;
        },

        persist() {
          this.db.meta.savedAt = new Date().toISOString();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(this.db));
        },

        toggleDark() {
          this.isDark = !this.isDark;
          this.applyDarkClass();
        },

        applyDarkClass() {
          const html = document.documentElement;
          if (this.isDark) html.classList.add('dark');
          else html.classList.remove('dark');
        },

        openModal(view) {
          this.modal.open = true;
          this.modal.view = view;

          const titles = {
            saasForm: (this.forms.saas.id ? 'Editar empresa' : 'Nueva empresa'),
            planForm: (this.forms.plan.id ? 'Editar plan' : 'Nuevo plan'),
            campaignForm: (this.forms.campaign.id ? 'Editar campaña' : 'Nueva campaña'),
            extraForm: (this.forms.extra.id ? 'Editar servicio extra' : 'Nuevo servicio extra'),
            clientForm: (this.forms.client.id ? 'Editar cliente' : 'Nuevo cliente'),
            dataTools: 'Datos • Exportar / Importar / Demo'
          };
          this.modal.title = titles[view] || 'Formulario';

          // defaults
          if (view === 'campaignForm' && !this.forms.campaign.date) this.forms.campaign.date = todayISO();
          if (view === 'clientForm' && !this.forms.client.date) this.forms.client.date = todayISO();
        },

        closeModal() {
          this.modal.open = false;
          this.modal.view = '';
        },

        // Utilities
        fmtMoney(v) {
          const n = Number(v || 0);
          return n.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
        },
        shortUrl(u) {
          if (!u) return '-';
          try {
            const url = new URL(u);
            return url.host;
          } catch { return u; }
        },

        // Filters
        matchQuery(text) {
          const q = (this.q || '').trim().toLowerCase();
          if (!q) return true;
          return String(text || '').toLowerCase().includes(q);
        },

        filteredSaaS() {
          return this.db.saas.filter(s =>
            this.matchQuery(s.name) || this.matchQuery(s.url) || this.matchQuery(s.registerUrl) || this.matchQuery(s.loginUrl)
          );
        },

        filteredPlans() {
          return this.db.plans.filter(p =>
            this.matchQuery(p.title) || this.matchQuery(p.description) || this.matchQuery(this.saasName(p.saasId))
          );
        },

        filteredCampaigns() {
          return this.db.campaigns.filter(c =>
            this.matchQuery(c.adName) || this.matchQuery(c.date) || this.matchQuery(this.saasName(c.saasId))
          ).sort((a,b) => (b.date || '').localeCompare(a.date || ''));
        },

        filteredExtras() {
          return this.db.extras.filter(e =>
            this.matchQuery(e.name) || this.matchQuery(e.frequency)
          );
        },

        filteredClients() {
          return this.db.clients.filter(cl => {
            const extrasText = (cl.extraIds||[]).map(id => this.extraName(id)).join(' ');
            return (
              this.matchQuery(cl.name) ||
              this.matchQuery(cl.notes) ||
              this.matchQuery(cl.links) ||
              this.matchQuery(cl.email) ||
              this.matchQuery(this.saasName(cl.saasId)) ||
              this.matchQuery(this.planTitle(cl.planId)) ||
              this.matchQuery(extrasText)
            );
          }).sort((a,b) => (b.date || '').localeCompare(a.date || ''));
        },

        totalRecordsFiltered() {
          switch(this.activeTab) {
            case 'saas': return this.filteredSaaS().length;
            case 'plans': return this.filteredPlans().length;
            case 'campaigns': return this.filteredCampaigns().length;
            case 'clients': return this.filteredClients().length;
            case 'extras': return this.filteredExtras().length;
            default: return this.db.saas.length + this.db.plans.length + this.db.campaigns.length + this.db.clients.length + this.db.extras.length;
          }
        },

        // Relations helpers
        saasName(saasId) {
          return this.db.saas.find(x => x.id === saasId)?.name || '-';
        },
        plansBySaas(saasId) {
          if (!saasId) return [];
          return this.db.plans.filter(p => p.saasId === saasId);
        },
        campaignsBySaas(saasId) {
          if (!saasId) return [];
          return this.db.campaigns.filter(c => c.saasId === saasId);
        },
        countPlansBySaas(saasId) {
          return this.db.plans.filter(p => p.saasId === saasId).length;
        },
        countClientsBySaas(saasId) {
          return this.db.clients.filter(c => c.saasId === saasId).length;
        },

        planTitle(planId) {
          return this.db.plans.find(p => p.id === planId)?.title || '-';
        },
        planFrequency(planId) {
          return this.db.plans.find(p => p.id === planId)?.frequency || '-';
        },
        planPrice(planId) {
          return Number(this.db.plans.find(p => p.id === planId)?.price || 0);
        },

        extraName(extraId) {
          return this.db.extras.find(e => e.id === extraId)?.name || '(extra borrado)';
        },
        extraPrice(extraId) {
          return Number(this.db.extras.find(e => e.id === extraId)?.price || 0);
        },
        extraFrequency(extraId) {
          return this.db.extras.find(e => e.id === extraId)?.frequency || 'Única vez';
        },

        // Campaign formulas
        calcTaxes(c) {
          const daily = Number(c?.dailySpend || 0);
          const total = Number(c?.totalSpend || 0);
          const taxes = total - daily;
          return taxes > 0 ? taxes : 0;
        },
        calcTotalWithTaxes(c) {
          const daily = Number(c?.dailySpend || 0);
          const total = Number(c?.totalSpend || 0);
          // si el user no completa total, asumimos "sin impuestos"
          if (!total || total <= 0) return daily;
          // si total es menor que daily, no tiene sentido: devolvemos daily
          return total < daily ? daily : total;
        },

        // Totals / reports
        sumDailySpendAll() {
          return this.db.campaigns.reduce((acc, c) => acc + Number(c.dailySpend||0), 0);
        },
        totalAdsSpendAllTime() {
          return this.db.campaigns.reduce((acc, c) => acc + this.calcTotalWithTaxes(c), 0);
        },
        totalAdsSpendBySaas(saasId) {
          return this.db.campaigns
            .filter(c => c.saasId === saasId)
            .reduce((acc, c) => acc + this.calcTotalWithTaxes(c), 0);
        },
        sumDailySpendBySaas(saasId) {
          return this.db.campaigns
            .filter(c => c.saasId === saasId)
            .reduce((acc, c) => acc + Number(c.dailySpend||0), 0);
        },
        adsSpendToday() {
          // estimación: suma totalWithTaxes por campaña (como lo pediste)
          return this.db.campaigns.reduce((acc, c) => acc + this.calcTotalWithTaxes(c), 0);
        },
        adsSpendWeek() {
          return this.adsSpendToday() * 7;
        },

        // Client totals (normalizado a "mensual estimado" para dashboard)
        normalizeToMonthly(amount, frequency) {
          const v = Number(amount || 0);
          if (frequency === 'Por año') return v / 12;
          if (frequency === 'Por mes') return v;
          // Única vez: lo prorrateamos en 12 para estimación suave (podés cambiarlo)
          if (frequency === 'Única vez') return v / 12;
          return v;
        },

        clientTotal(cl) {
          // total nominal (no normalizado): plan + extras (sumando como estén)
          const plan = this.db.plans.find(p => p.id === cl.planId);
          const planPrice = Number(plan?.price || 0);
          let extras = 0;
          (cl.extraIds || []).forEach(id => extras += this.extraPrice(id));
          return planPrice + extras;
        },

        incomePlansMonthlyEstimate() {
          return this.db.clients.reduce((acc, cl) => {
            const plan = this.db.plans.find(p => p.id === cl.planId);
            acc += this.normalizeToMonthly(plan?.price || 0, plan?.frequency || 'Por mes');
            return acc;
          }, 0);
        },

        incomeExtrasMonthlyEstimate() {
          return this.db.clients.reduce((acc, cl) => {
            (cl.extraIds || []).forEach(id => {
              acc += this.normalizeToMonthly(this.extraPrice(id), this.extraFrequency(id));
            });
            return acc;
          }, 0);
        },

        totalIncomeEstimate() {
          return this.incomePlansMonthlyEstimate() + this.incomeExtrasMonthlyEstimate();
        },

        domainExtrasCount() {
          // heurística: cuenta extras que contengan "dominio"
          const domainExtraIds = this.db.extras
            .filter(e => (e.name || '').toLowerCase().includes('dominio'))
            .map(e => e.id);

          return this.db.clients.reduce((acc, cl) => {
            const has = (cl.extraIds || []).some(id => domainExtraIds.includes(id));
            return acc + (has ? 1 : 0);
          }, 0);
        },

        totalExpensesManual() {
          return this.db.expenses.reduce((acc, ex) => acc + Number(ex.amount || 0), 0);
        },

        balanceEstimate() {
          // Saldo estimado: ingresos (mensual estimado) - egresos manuales - ads total
          return this.totalIncomeEstimate() - this.totalExpensesManual() - this.totalAdsSpendAllTime();
        },

        // CRUD: SaaS
        resetSaasForm() {
          this.forms.saas = { id: '', name: '', url: '', registerUrl: '', loginUrl: '' };
        },
        editSaas(id) {
          const s = this.db.saas.find(x => x.id === id);
          if (!s) return;
          this.forms.saas = JSON.parse(JSON.stringify(s));
          this.openModal('saasForm');
        },
        saveSaas() {
          const f = this.forms.saas;
          if (!String(f.name || '').trim()) return alert('Falta el nombre.');
          if (!String(f.url || '').trim()) return alert('Falta la URL.');

          if (f.id) {
            const idx = this.db.saas.findIndex(x => x.id === f.id);
            if (idx >= 0) this.db.saas[idx] = { ...this.db.saas[idx], ...f };
          } else {
            this.db.saas.push({ ...f, id: uid() });
          }
          this.persist();
          this.closeModal();
          this.resetSaasForm();
        },
        delSaas(id) {
          if (!confirm('¿Borrar empresa? Esto NO borra planes/clientes automáticamente.')) return;
          this.db.saas = this.db.saas.filter(x => x.id !== id);
          this.persist();
        },

        // CRUD: Plans
        resetPlanForm() {
          this.forms.plan = { id: '', saasId: '', frequency: 'Por mes', title: '', description: '', price: 0 };
        },
        editPlan(id) {
          const p = this.db.plans.find(x => x.id === id);
          if (!p) return;
          this.forms.plan = JSON.parse(JSON.stringify(p));
          this.openModal('planForm');
        },
        savePlan() {
          const f = this.forms.plan;
          if (!f.saasId) return alert('Seleccioná una empresa.');
          if (!String(f.title || '').trim()) return alert('Falta el título.');
          if (!Number(f.price || 0)) return alert('Falta el precio.');

          if (f.id) {
            const idx = this.db.plans.findIndex(x => x.id === f.id);
            if (idx >= 0) this.db.plans[idx] = { ...this.db.plans[idx], ...f, price: Number(f.price||0) };
          } else {
            this.db.plans.push({ ...f, id: uid(), price: Number(f.price||0) });
          }
          this.persist();
          this.closeModal();
          this.resetPlanForm();
        },
        delPlan(id) {
          if (!confirm('¿Borrar plan? Clientes que lo usen quedarán con plan “-”.')) return;
          this.db.plans = this.db.plans.filter(x => x.id !== id);
          this.persist();
        },

        // CRUD: Campaigns
        resetCampaignForm() {
          this.forms.campaign = { id: '', saasId: '', adName: '', date: todayISO(), dailySpend: 0, totalSpend: 0 };
        },
        editCampaign(id) {
          const c = this.db.campaigns.find(x => x.id === id);
          if (!c) return;
          this.forms.campaign = JSON.parse(JSON.stringify(c));
          this.openModal('campaignForm');
        },
        saveCampaign() {
          const f = this.forms.campaign;
          if (!f.saasId) return alert('Seleccioná una empresa.');
          if (!String(f.adName || '').trim()) return alert('Falta el anuncio/nombre.');
          if (!String(f.date || '').trim()) f.date = todayISO();
          f.dailySpend = Number(f.dailySpend||0);
          f.totalSpend = Number(f.totalSpend||0);

          if (!f.dailySpend) return alert('Cargá gasto por día.');

          if (f.id) {
            const idx = this.db.campaigns.findIndex(x => x.id === f.id);
            if (idx >= 0) this.db.campaigns[idx] = { ...this.db.campaigns[idx], ...f };
          } else {
            this.db.campaigns.push({ ...f, id: uid() });
          }
          this.persist();
          this.closeModal();
          this.resetCampaignForm();
        },
        delCampaign(id) {
          if (!confirm('¿Borrar campaña?')) return;
          this.db.campaigns = this.db.campaigns.filter(x => x.id !== id);
          this.persist();
        },

        // CRUD: Extras
        resetExtraForm() {
          this.forms.extra = { id: '', name: '', price: 0, frequency: 'Única vez' };
        },
        editExtra(id) {
          const e = this.db.extras.find(x => x.id === id);
          if (!e) return;
          this.forms.extra = JSON.parse(JSON.stringify(e));
          this.openModal('extraForm');
        },
        saveExtra() {
          const f = this.forms.extra;
          if (!String(f.name || '').trim()) return alert('Falta el nombre.');
          f.price = Number(f.price||0);
          if (!f.price) return alert('Falta el precio.');

          if (f.id) {
            const idx = this.db.extras.findIndex(x => x.id === f.id);
            if (idx >= 0) this.db.extras[idx] = { ...this.db.extras[idx], ...f };
          } else {
            this.db.extras.push({ ...f, id: uid() });
          }
          this.persist();
          this.closeModal();
          this.resetExtraForm();
        },
        delExtra(id) {
          if (!confirm('¿Borrar extra? Clientes que lo usen lo perderán.')) return;
          // quitar de clientes
          this.db.clients = this.db.clients.map(c => ({
            ...c,
            extraIds: (c.extraIds||[]).filter(x => x !== id)
          }));
          this.db.extras = this.db.extras.filter(x => x.id !== id);
          this.persist();
        },

        // CRUD: Clients
        resetClientForm() {
          this.forms.client = { id:'', name:'', saasId:'', planId:'', extraIds:[], email:'', password:'', date: todayISO(), notes:'', links:'' };
        },
        syncPlanToCompany() {
          // si plan no pertenece a esa empresa, lo limpia
          const saasId = this.forms.client.saasId;
          const plan = this.db.plans.find(p => p.id === this.forms.client.planId);
          if (plan && plan.saasId !== saasId) this.forms.client.planId = '';
        },
        toggleClientExtra(extraId, checked) {
          const list = new Set(this.forms.client.extraIds || []);
          if (checked) list.add(extraId);
          else list.delete(extraId);
          this.forms.client.extraIds = Array.from(list);
        },
        editClient(id) {
          const cl = this.db.clients.find(x => x.id === id);
          if (!cl) return;
          this.forms.client = JSON.parse(JSON.stringify(cl));
          this.openModal('clientForm');
        },
        saveClient() {
          const f = this.forms.client;
          if (!String(f.name || '').trim()) return alert('Falta el nombre.');
          if (!f.saasId) return alert('Seleccioná una empresa.');
          if (!f.planId) return alert('Seleccioná un plan activo.');

          if (f.id) {
            const idx = this.db.clients.findIndex(x => x.id === f.id);
            if (idx >= 0) this.db.clients[idx] = { ...this.db.clients[idx], ...f };
          } else {
            this.db.clients.push({ ...f, id: uid() });
          }
          this.persist();
          this.closeModal();
          this.resetClientForm();
        },
        delClient(id) {
          if (!confirm('¿Borrar cliente?')) return;
          this.db.clients = this.db.clients.filter(x => x.id !== id);
          this.persist();
        },

        // Manual expenses
        addExpense() {
          const n = (this.expenseForm.name || '').trim();
          const a = Number(this.expenseForm.amount || 0);
          const d = (this.expenseForm.date || '').trim();
          if (!n) return alert('Falta el concepto.');
          if (!a) return alert('Falta el monto.');
          this.db.expenses.push({ name: n, amount: a, date: d || todayISO() });
          this.expenseForm = { name: '', amount: 0, date: '' };
          this.persist();
        },
        removeExpense(idx) {
          this.db.expenses.splice(idx, 1);
          this.persist();
        },
        clearExpenses() {
          if (!confirm('¿Borrar todos los egresos manuales?')) return;
          this.db.expenses = [];
          this.persist();
        },

        // Data tools
        exportJSON() {
          const blob = new Blob([JSON.stringify(this.db, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `aapp_manager_backup_${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        },

        importJSON() {
          const txt = (this.importText || '').trim();
          if (!txt) return alert('Pegá un JSON primero.');
          if (!confirm('Esto reemplaza todos tus datos actuales. ¿Continuar?')) return;

          try {
            const parsed = JSON.parse(txt);
            this.db = this.normalizeDB(parsed);
            this.persist();
            alert('Importado OK.');
            this.closeModal();
          } catch (e) {
            alert('JSON inválido.');
          }
        },

        resetAll() {
          if (!confirm('RESET TOTAL: se borra todo el localStorage de esta app. ¿Continuar?')) return;
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        },

        // Seeds
        seedMinimal() {
          this.db = {
            saas: [
              { id: uid(), name: 'AAPP.SPACE', url: 'https://aapp.space', registerUrl: '', loginUrl: '' },
              { id: uid(), name: 'MiniTienda', url: 'https://minitienda.uno', registerUrl: '', loginUrl: '' }
            ],
            plans: [],
            campaigns: [],
            extras: [],
            clients: [],
            expenses: [],
            meta: { version: 1, savedAt: null }
          };
          this.persist();
        },

        seedDemo() {
          const s1 = uid(), s2 = uid();
          const p1 = uid(), p2 = uid(), p3 = uid();
          const e1 = uid(), e2 = uid(), e3 = uid();
          const c1 = uid(), c2 = uid();

          this.db = {
            saas: [
              { id: s1, name: 'AAPP.SPACE', url: 'https://aapp.space', registerUrl: 'https://aapp.space/register', loginUrl: 'https://aapp.space/login' },
              { id: s2, name: 'MiniTienda', url: 'https://minitienda.uno', registerUrl: 'https://minitienda.uno/register', loginUrl: 'https://minitienda.uno/login' }
            ],
            plans: [
              { id: p1, saasId: s1, frequency: 'Por mes', title: 'Básico', description: 'Sitio/tienda + WhatsApp + panel editable', price: 100000 },
              { id: p2, saasId: s1, frequency: 'Por año', title: 'Premium', description: 'Más páginas + soporte + optimizaciones', price: 900000 },
              { id: p3, saasId: s2, frequency: 'Por año', title: 'Oferta Anual', description: 'Tienda conectada a WhatsApp + carrito + pedidos', price: 150000 }
            ],
            campaigns: [
              { id: uid(), saasId: s2, adName: 'Meta Ads • Tienda WhatsApp', date: todayISO(), dailySpend: 15000, totalSpend: 19500 },
              { id: uid(), saasId: s1, adName: 'Lead Ads • AAPP.SPACE', date: todayISO(), dailySpend: 20000, totalSpend: 26000 }
            ],
            extras: [
              { id: e1, name: 'Dominio .com / .com.ar', price: 50000, frequency: 'Por año' },
              { id: e2, name: 'Diseño de logo', price: 25000, frequency: 'Única vez' },
              { id: e3, name: 'Setup / Configuración', price: 100000, frequency: 'Única vez' }
            ],
            clients: [
              { id: c1, name: 'Cliente Ejemplo 1', saasId: s2, planId: p3, extraIds: [e1], email: 'cliente1@mail.com', password: '1234', date: todayISO(), notes: 'Paga anual, pedir catálogo', links: 'Panel: /login' },
              { id: c2, name: 'Cliente Ejemplo 2', saasId: s1, planId: p1, extraIds: [e2, e3], email: 'cliente2@mail.com', password: 'abcd', date: todayISO(), notes: 'Quiere activar hoy', links: 'Drive: carpeta propuesta' }
            ],
            expenses: [
              { name: 'Hosting / VPS', amount: 25000, date: todayISO() }
            ],
            meta: { version: 1, savedAt: null }
          };

          this.persist();
          alert('Demo cargada.');
          this.closeModal();
        }
      }
    }
  </script>
</body>
</html>
